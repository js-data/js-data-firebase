/*!
* js-data-firebase
* @version 3.0.0 - Homepage <https://github.com/js-data/js-data-firebase>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2016 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-firebase/blob/master/LICENSE>
*
* @overview firebase adapter for js-data.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("js-data"),require("firebase")):"function"==typeof define&&define.amd?define(["exports","js-data","firebase"],t):t(e.JSDataFirebase={},e.JSData,e.firebase)}(this,function(e,t,n){"use strict";function Response(e,n,r){n||(n={}),this.data=e,t.utils.fillIn(this,n),this.op=r}function Adapter(e){t.utils.classCallCheck(this,Adapter),t.Component.call(this,e),e||(e={}),t.utils.fillIn(e,l),t.utils.fillIn(this,e)}function enqueue(e){f.push(e)}function dequeue(){f.length&&!c&&(c=!0,f[0]())}function queueTask(e){f.length?enqueue(e):(enqueue(e),dequeue())}function createTask(e){return new t.utils.Promise(e).then(function(e){return c=!1,f.shift(),setTimeout(dequeue,0),e},function(e){return c=!1,f.shift(),setTimeout(dequeue,0),t.utils.reject(e)})}function FirebaseAdapter(e){t.utils.classCallCheck(this,FirebaseAdapter),e||(e={}),Adapter.call(this,e),e.db&&(this.db=e.db||n.database())}n=n&&n.hasOwnProperty("default")?n.default:n;var r=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},i=function(){function sliceIterator(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var u,a=e[Symbol.iterator]();!(r=(u=a.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return sliceIterator(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function noop(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];var i=n[n.length-1];return this.dbg.apply(this,[i.op].concat(n)),t.utils.resolve()},u=function noop2(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];var i=n[n.length-2];return this.dbg.apply(this,[i.op].concat(n)),t.utils.resolve()},a=function unique(e){var t={},n=[];return e.forEach(function(e){e in t||(n.push(e),t[e]=0)}),n},s=function withoutRelations(e,n,r){r||(r={}),r.with||(r.with=[]);var i=(e.relationFields||[]).filter(function(e){return-1===r.with.indexOf(e)});return t.utils.omit(n,i)},l={debug:!1,raw:!1};t.Component.extend({constructor:Adapter,afterCount:u,afterCreate:u,afterCreateMany:u,afterDestroy:u,afterDestroyAll:u,afterFind:u,afterFindAll:u,afterSum:u,afterUpdate:u,afterUpdateAll:u,afterUpdateMany:u,beforeCount:o,beforeCreate:o,beforeCreateMany:o,beforeDestroy:o,beforeDestroyAll:o,beforeFind:o,beforeFindAll:o,beforeSum:o,beforeUpdate:o,beforeUpdateAll:o,beforeUpdateMany:o,count:function count(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeCount",t.utils.resolve(this[u](e,n,r)).then(function(){return u=r.op="count",o.dbg(u,e,n,r),t.utils.resolve(o._count(e,n,r))}).then(function(a){var s=i(a,2),l=s[0],f=s[1];f||(f={});var c=new Response(l,f,u);return c=o.respond(c,r),u=r.op="afterCount",t.utils.resolve(o[u](e,n,r,c)).then(function(e){return void 0===e?c:e})})},create:function create(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeCreate",t.utils.resolve(this[u](e,n,r)).then(function(i){return n=void 0===i?n:i,n=s(e,n,r),u=r.op="create",o.dbg(u,e,n,r),t.utils.resolve(o._create(e,n,r))}).then(function(a){var s=i(a,2),l=s[0],f=s[1];f||(f={});var c=new Response(l,f,"create");return c.created=l?1:0,c=o.respond(c,r),u=r.op="afterCreate",t.utils.resolve(o[u](e,n,r,c)).then(function(e){return void 0===e?c:e})})},createMany:function createMany(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeCreateMany",t.utils.resolve(this[u](e,n,r)).then(function(i){return n=void 0===i?n:i,n=n.map(function(t){return s(e,t,r)}),u=r.op="createMany",o.dbg(u,e,n,r),t.utils.resolve(o._createMany(e,n,r))}).then(function(a){var s=i(a,2),l=s[0],f=s[1];l||(l=[]),f||(f={});var c=new Response(l,f,"createMany");return c.created=l.length,c=o.respond(c,r),u=r.op="afterCreateMany",t.utils.resolve(o[u](e,n,r,c)).then(function(e){return void 0===e?c:e})})},destroy:function destroy(e,n,r){var o=this,u=void 0;return r||(r={}),u=r.op="beforeDestroy",t.utils.resolve(this[u](e,n,r)).then(function(){return u=r.op="destroy",o.dbg(u,e,n,r),t.utils.resolve(o._destroy(e,n,r))}).then(function(a){var s=i(a,2),l=s[0],f=s[1];f||(f={});var c=new Response(l,f,"destroy");return c=o.respond(c,r),u=r.op="afterDestroy",t.utils.resolve(o[u](e,n,r,c)).then(function(e){return void 0===e?c:e})})},destroyAll:function destroyAll(e,n,r){var o=this,u=void 0;return n||(n={}),r||(r={}),u=r.op="beforeDestroyAll",t.utils.resolve(this[u](e,n,r)).then(function(){return u=r.op="destroyAll",o.dbg(u,e,n,r),t.utils.resolve(o._destroyAll(e,n,r))}).then(function(a){var s=i(a,2),l=s[0],f=s[1];f||(f={});var c=new Response(l,f,"destroyAll");return c=o.respond(c,r),u=r.op="afterDestroyAll",t.utils.resolve(o[u](e,n,r,c)).then(function(e){return void 0===e?c:e})})},loadBelongsTo:function loadBelongsTo(e,n,i,o){var u=this,a=n.getRelation();if(t.utils.isObject(i)&&!t.utils.isArray(i)){var s=i;return this.find(a,this.makeBelongsToForeignKey(e,n,s),o).then(function(e){n.setLocalField(s,e)})}var l=i.map(function(t){return u.makeBelongsToForeignKey(e,n,t)}).filter(function(e){return e});return this.findAll(a,{where:r({},a.idAttribute,{in:l})},o).then(function(e){i.forEach(function(t){e.forEach(function(e){e[a.idAttribute]===t[n.foreignKey]&&n.setLocalField(t,e)})})})},find:function find(e,n,r){var o=this,u=void 0;return r||(r={}),r.with||(r.with=[]),u=r.op="beforeFind",t.utils.resolve(this[u](e,n,r)).then(function(){return u=r.op="find",o.dbg(u,e,n,r),t.utils.resolve(o._find(e,n,r))}).then(function(t){return o.loadRelationsFor(e,t,r)}).then(function(a){var s=i(a,2),l=s[0],f=new Response(l,s[1],"find");return f.found=l?1:0,f=o.respond(f,r),u=r.op="afterFind",t.utils.resolve(o[u](e,n,r,f)).then(function(e){return void 0===e?f:e})})},findAll:function findAll(e,n,r){var o=this,u=void 0;r||(r={}),r.with||(r.with=[]);var a=r._activeWith;if(t.utils.isObject(a)){var s=a.query||{};a.replace?n=s:t.utils.deepFillIn(n,s)}return u=r.op="beforeFindAll",t.utils.resolve(this[u](e,n,r)).then(function(){return u=r.op="findAll",o.dbg(u,e,n,r),t.utils.resolve(o._findAll(e,n,r))}).then(function(t){return o.loadRelationsFor(e,t,r)}).then(function(a){var s=i(a,2),l=s[0],f=new Response(l,s[1],"findAll");return f.found=l.length,f=o.respond(f,r),u=r.op="afterFindAll",t.utils.resolve(o[u](e,n,r,f)).then(function(e){return void 0===e?f:e})})},loadRelationsFor:function loadRelationsFor(e,n,r){var o=this,u=i(n,1)[0],a=[];return u&&t.utils.forEachRelation(e,r,function(t,n){var r=void 0;!t.foreignKey||"hasOne"!==t.type&&"hasMany"!==t.type?"hasMany"===t.type&&t.localKeys?r=o.loadHasManyLocalKeys(e,t,u,n):"hasMany"===t.type&&t.foreignKeys?r=o.loadHasManyForeignKeys(e,t,u,n):"belongsTo"===t.type&&(r=o.loadBelongsTo(e,t,u,n)):r="hasOne"===t.type?o.loadHasOne(e,t,u,n):o.loadHasMany(e,t,u,n),r&&a.push(r)}),t.utils.Promise.all(a).then(function(){return n})},getOpt:function getOpt(e,n){return n||(n={}),void 0===n[e]?t.utils.plainCopy(this[e]):t.utils.plainCopy(n[e])},loadHasMany:function loadHasMany(e,n,r,i){var o=this,u=!1;t.utils.isObject(r)&&!t.utils.isArray(r)&&(u=!0,r=[r]);var a=r.map(function(t){return o.makeHasManyForeignKey(e,n,t)}),s={where:{}},l=s.where[n.foreignKey]={};return u?l["=="]=a[0]:l.in=a.filter(function(e){return e}),this.findAll(n.getRelation(),s,i).then(function(i){r.forEach(function(r){var o=[];u?o=i:i.forEach(function(i){t.utils.get(i,n.foreignKey)===r[e.idAttribute]&&o.push(i)}),n.setLocalField(r,o)})})},loadHasManyLocalKeys:function loadHasManyLocalKeys(e,n,i,o){var u=this,s=void 0,l=n.getRelation();if(t.utils.isObject(i)&&!t.utils.isArray(i)&&(s=i),s)return this.findAll(l,{where:r({},l.idAttribute,{in:this.makeHasManyLocalKeys(e,n,s)})},o).then(function(e){n.setLocalField(s,e)});var f=[];return i.forEach(function(t){f=f.concat(u.makeHasManyLocalKeys(e,n,t))}),this.findAll(l,{where:r({},l.idAttribute,{in:a(f).filter(function(e){return e})})},o).then(function(e){return i.forEach(function(r){var i=[],o=t.utils.get(r,n.localKeys)||[];o=t.utils.isArray(o)?o:Object.keys(o),e.forEach(function(e){o&&-1!==o.indexOf(e[l.idAttribute])&&i.push(e)}),n.setLocalField(r,i)}),e})},loadHasManyForeignKeys:function loadHasManyForeignKeys(e,n,i,o){var u=this,a=n.getRelation(),s=e.idAttribute,l=void 0;return t.utils.isObject(i)&&!t.utils.isArray(i)&&(l=i),l?this.findAll(n.getRelation(),{where:r({},n.foreignKeys,{contains:this.makeHasManyForeignKeys(e,n,l)})},o).then(function(e){n.setLocalField(l,e)}):this.findAll(a,{where:r({},n.foreignKeys,{isectNotEmpty:i.map(function(t){return u.makeHasManyForeignKeys(e,n,t)})})},o).then(function(e){var r=n.foreignKeys;i.forEach(function(i){var o=[],u=t.utils.get(i,s);e.forEach(function(n){-1!==(t.utils.get(e,r)||[]).indexOf(u)&&o.push(n)}),n.setLocalField(i,o)})})},loadHasOne:function loadHasOne(e,n,r,i){return t.utils.isObject(r)&&!t.utils.isArray(r)&&(r=[r]),this.loadHasMany(e,n,r,i).then(function(){r.forEach(function(e){var r=n.getLocalField(e);t.utils.isArray(r)&&r.length&&n.setLocalField(e,r[0])})})},makeHasManyForeignKey:function makeHasManyForeignKey(e,t,n){return t.getForeignKey(n)},makeHasManyLocalKeys:function makeHasManyLocalKeys(e,n,r){var i=[],o=t.utils.get(r,n.localKeys)||[];return o=t.utils.isArray(o)?o:Object.keys(o),i=i.concat(o),a(i).filter(function(e){return e})},makeHasManyForeignKeys:function makeHasManyForeignKeys(e,n,r){return t.utils.get(r,e.idAttribute)},makeBelongsToForeignKey:function makeBelongsToForeignKey(e,t,n){return t.getForeignKey(n)},sum:function sum(e,n,r,o){var u=this,a=void 0;if(!t.utils.isString(n))throw new Error("field must be a string!");return r||(r={}),o||(o={}),a=o.op="beforeSum",t.utils.resolve(this[a](e,n,r,o)).then(function(){return a=o.op="sum",u.dbg(a,e,n,r,o),t.utils.resolve(u._sum(e,n,r,o))}).then(function(s){var l=i(s,2),f=l[0],c=l[1];c||(c={});var d=new Response(f,c,a);return d=u.respond(d,o),a=o.op="afterSum",t.utils.resolve(u[a](e,n,r,o,d)).then(function(e){return void 0===e?d:e})})},respond:function respond(e,t){return this.getOpt("raw",t)?e:e.data},update:function update(e,n,r,o){var u=this;r||(r={}),o||(o={});var a=void 0;return a=o.op="beforeUpdate",t.utils.resolve(this[a](e,n,r,o)).then(function(i){return r=void 0===i?r:i,r=s(e,r,o),a=o.op="update",u.dbg(a,e,n,r,o),t.utils.resolve(u._update(e,n,r,o))}).then(function(s){var l=i(s,2),f=l[0],c=l[1];c||(c={});var d=new Response(f,c,"update");return d.updated=f?1:0,d=u.respond(d,o),a=o.op="afterUpdate",t.utils.resolve(u[a](e,n,r,o,d)).then(function(e){return void 0===e?d:e})})},updateAll:function updateAll(e,n,r,o){var u=this;n||(n={}),r||(r={}),o||(o={});var a=void 0;return a=o.op="beforeUpdateAll",t.utils.resolve(this[a](e,n,r,o)).then(function(i){return n=void 0===i?n:i,n=s(e,n,o),a=o.op="updateAll",u.dbg(a,e,n,r,o),t.utils.resolve(u._updateAll(e,n,r,o))}).then(function(s){var l=i(s,2),f=l[0],c=l[1];f||(f=[]),c||(c={});var d=new Response(f,c,"updateAll");return d.updated=f.length,d=u.respond(d,o),a=o.op="afterUpdateAll",t.utils.resolve(u[a](e,n,r,o,d)).then(function(e){return void 0===e?d:e})})},updateMany:function updateMany(e,n,r){var o=this;n||(n=[]),r||(r={});var u=void 0,a=e.idAttribute;return n=n.filter(function(e){return t.utils.get(e,a)}),u=r.op="beforeUpdateMany",t.utils.resolve(this[u](e,n,r)).then(function(i){return n=void 0===i?n:i,n=n.map(function(t){return s(e,t,r)}),u=r.op="updateMany",o.dbg(u,e,n,r),t.utils.resolve(o._updateMany(e,n,r))}).then(function(a){var s=i(a,2),l=s[0],f=s[1];l||(l=[]),f||(f={});var c=new Response(l,f,"updateMany");return c.updated=l.length,c=o.respond(c,r),u=r.op="afterUpdateMany",t.utils.resolve(o[u](e,n,r,c)).then(function(e){return void 0===e?c:e})})}});var f=[],c=!1,d=Adapter.prototype;FirebaseAdapter.prototype=Object.create(Adapter.prototype,{constructor:{value:FirebaseAdapter,enumerable:!1,writable:!0,configurable:!0}}),Object.defineProperty(FirebaseAdapter,"__super__",{configurable:!0,value:Adapter}),FirebaseAdapter.extend=t.utils.extend,t.utils.addHiddenPropsToTarget(FirebaseAdapter.prototype,{_count:function _count(e,t,n){return t||(t={}),n||(n={}),this._findAll(e,t,n).then(function(e){return e[0]=e[0].length,e})},_create:function _create(e,t,n){return t||(t={}),n||(n={}),this._upsert(e,t,n)},_upsert:function _upsert(e,n,r){var i=this,o=t.utils.plainCopy(n);r||(r={});var u=t.utils.get(o,e.idAttribute),a=this.getRef(e,r),s=void 0;return t.utils.isSorN(u)?s=a.child(u):(s=a.push(),t.utils.set(o,e.idAttribute,s.key)),s.set(o).then(function(){return i._once(s)}).then(function(e){if(!e)throw new Error("Not Found");return[e,{ref:s}]})},_upsertBatch:function _upsertBatch(e,n,r){var i=this;r||(r={});var o=e.idAttribute,u=[],a=this.getRef(e,r);return n.forEach(function(e){var n=t.utils.get(e,o),r=t.utils.plainCopy(e),i=void 0;t.utils.isSorN(n)?i=a.child(n):(i=a.push(),t.utils.set(r,o,i.key)),u.push({ref:i,props:r})}),this._atomicUpdate(e,u,r).then(function(){return t.utils.Promise.all(u.map(function(e){return i._once(e.ref)}))}).then(function(e){return[e,{ref:u.map(function(e){return e.ref})}]})},_once:function _once(e){return e.once("value").then(function(e){return e.exists()?e.val():null})},_atomicUpdate:function _atomicUpdate(e,t,n){var r=this,i={};return t.forEach(function(t){i[t.ref.toString().replace(r.getRef(e,n).toString(),"")]=t.props}),this.getRef(e,n).update(i)},_createMany:function _createMany(e,t,n){return n||(n={}),this._upsertBatch(e,t,n)},_destroy:function _destroy(e,t,n){n||(n={});var r=this.getRef(e,n).child(t);return r.remove().then(function(){return[void 0,{ref:r}]})},_destroyAll:function _destroyAll(e,n,r){var o=this;return n||(n={}),r||(r={}),this._findAll(e,n).then(function(n){var u=i(n,1)[0],a=e.idAttribute;return t.utils.Promise.all(u.map(function(n){return o._destroy(e,t.utils.get(n,a),r)}))}).then(function(){return[void 0,{}]})},_find:function _find(e,t,n){n||(n={});var r=this.getRef(e,n).child(t);return this._once(r).then(function(e){return e||(e=void 0),[e,{ref:r}]})},_findAll:function _findAll(e,n,r){n||(n={}),r||(r={});var i=this.getRef(e,r);return i.once("value").then(function(e){var r=e.val();if(!r)return[[],{ref:i}];var o=[];return t.utils.forOwn(r,function(e,t){o.push(e)}),[new t.Query({index:{getAll:function getAll(){return o}}}).filter(n).run(),{ref:i}]})},_sum:function _sum(e,n,r,i){return this._findAll(e,r,i).then(function(e){return e[0]=e[0].reduce(function(e,r){return e+(t.utils.get(r,n)||0)},0),e})},_update:function _update(e,n,r,i){var o=this;r||(r={}),i||(i={});var u=this.getRef(e,i).child(n);return this._once(u).then(function(e){if(!e)throw new Error("Not Found");return t.utils.deepMixIn(e,r),u.set(e)}).then(function(){return o._once(u)}).then(function(e){if(!e)throw new Error("Not Found");return[e,{ref:u}]})},_updateAll:function _updateAll(e,n,r,o){var u=this;return o||(o={}),n||(n={}),r||(r={}),this._findAll(e,r,o).then(function(r){var a=i(r,1)[0];return a.forEach(function(e){return t.utils.deepMixIn(e,n)}),u._upsertBatch(e,a,o)})},_updateMany:function _updateMany(e,t,n){return n||(n={}),this._upsertBatch(e,t,n)},getRef:function getRef(e,t){return t=t||{},this.db.ref().child(t.endpoint||e.endpoint||e.name)},create:function create(e,t,n){var r=this;return createTask(function(i,o){queueTask(function(){d.create.call(r,e,t,n).then(i,o)})})},createMany:function createMany(e,t,n){var r=this;return createTask(function(i,o){queueTask(function(){d.createMany.call(r,e,t,n).then(i,o)})})},destroy:function destroy(e,t,n){var r=this;return createTask(function(i,o){queueTask(function(){d.destroy.call(r,e,t,n).then(i,o)})})},destroyAll:function destroyAll(e,t,n){var r=this;return createTask(function(i,o){queueTask(function(){d.destroyAll.call(r,e,t,n).then(i,o)})})},update:function update(e,t,n,r){var i=this;return createTask(function(o,u){queueTask(function(){d.update.call(i,e,t,n,r).then(o,u)})})},updateAll:function updateAll(e,t,n,r){var i=this;return createTask(function(o,u){queueTask(function(){d.updateAll.call(i,e,t,n,r).then(o,u)})})},updateMany:function updateMany(e,t,n){var r=this;return createTask(function(i,o){queueTask(function(){d.updateMany.call(r,e,t,n).then(i,o)})})}});var h={full:"3.0.0",major:3,minor:0,patch:0};e.FirebaseAdapter=FirebaseAdapter,e.version=h,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data-firebase.min.map